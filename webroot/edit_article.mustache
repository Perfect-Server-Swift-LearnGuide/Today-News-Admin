
<!-- 右侧编辑文章样式 -->
{{> add_style}}


<!-- 配置文件 -->
<script type="text/javascript" src="ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="ueditor.all.js"></script>
<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
<script type="text/javascript" charset="utf-8" src="lang/zh-cn/zh-cn.js"></script>
<script type="text/javascript" src="./js/public.js"></script>


<div id='add_article'>
	<h1>修改文章</h1>
	<form id='add_article_form'>
		<input type="hidden" name="id" value="{{id}}" />
		<div id='article_title'>
			<span>文章标题: </span>
			<input type="text" name="title" placeholder="请输入文章标题" value="{{title}}"></input>
		</div>
		<div id='article_source'>
			<span>文章来源: </span>
			<input type="text" name="source" placeholder="请输入文章来源" value="{{source}}"></input>
		</div>
		<div id='article_category'>
			<span>文章分类: </span>
			<select name="type" defselect="{{type}}">
				<option value="0">请选择</option>
			</select>
		</div>
		<div id="upload_list">
			<span>上传文章简要图: </span>
			<div id="placeholder_upload">
				<div id="upload_img">
					<img style="margin-top:100px;" src="./images/upload_place_img.png" />
					<p style="background-color:#ffa100;color:#fff;width:160px;height:20px;text-align:center;padding-top:10px;padding-bottom:10px;margin:0 auto;border-radius:5px;">
					选择图片
					<input type="file" accept="image/png,image/gif,image/jpg" name="article_thumbnail" class="add_img" onchange="add_imgs_action(event)" />
					</p>
			
				</div>
				<div id="upload_img_list">
					<div id="img_content">
						{{#thumbnails}}
						<span style="width:96px;height:100px;margin:5px;position:relative;">
							<img style="width:100%;height:100%;position:absolute;" id={{id}} src={{imgUrl}} />
							<p class="delete_img"></p>
						</span>
						{{/thumbnails}}
					</div>
					<div id="img_bottom">
					<p style="float:left;margin-left:80px;background-color:#ffa100;color:#fff;width:160px;height:20px;text-align:center;padding-top:10px;padding-bottom:10px;border-radius:5px;">
					选择图片
					<input type="file" accept="image/png,image/gif,image/jpg" name="article_thumbnail" class="add_img" onchange="add_imgs_action(event)" />
					</p>
					<p id="upload_img_action" style="float:right;margin-right:80px;background-color:#ffa100;color:#fff;width:160px;height:20px;padding-top:10px;padding-bottom:10px;text-align:center;border-radius:5px;">
					上传图片
					</p>
					</div>
				</div>
			</div>
		</div>
		<div id='article_content'>
			<span>文章内容: </span>
			<div class="clear"></div> 
			<div id="editer">
				<!-- 加载编辑器的容器 -->
				<script id="container" name="content" type="text/plain" style="width:640px;height:240px;">
					{{{content}}}
				</script>
			</div>
		
		</div>
		<div id='submit'>
			<p id='submit_btn'>提交<p>
		</div>
	</form>
<div>

<!-- 实例化编辑器 -->
<script type="text/javascript">
	var ue = UE.getEditor('container', {
		initialFrameWidth :640,//设置编辑器宽度
		initialFrameHeight:240,//设置编辑器高度
		scaleEnabled:true
	});  
	$(function(){
 
	})

 </script>

<script>
 //base64 转 二进制文件
function dataURItoBlob(dataURI) {
    var byteString = atob(dataURI.split(',')[1]);
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], {type: mimeString});
}

	var img_upload_formdata = new FormData();
// 添加图片
function add_imgs_action(e) {
	$("#upload_img").css("display", "none")
	$("#upload_img_list").css("display", "inline-block")
	
	if($("#upload_img_list #img_content").length > 8) {
		alert("最多选择9张图片")
		return false
	}

	var file = e.target.files[0];
    var reader = new FileReader();
    reader.onloadend = function () {
        // 图片的 base64 格式, 可以直接当成 img 的 src 属性值
		console.log("上传图片")
        var dataURL = reader.result;
		var blob = dataURItoBlob(dataURL);
		var date = new Date().Format("yyyy-MM-dd-hh-mm-ss");
		img_upload_formdata.append('article_thumbnail' + date, blob);
		var html = '<span style="width:96px;height:100px;margin:5px;position:relative;">' + 
		'<img style="width:100%;height:100%;position:absolute;" id="'+date+'" src="'+dataURL+'" />' + 
		'<p class="delete_img"></p>' +
		'</span>'
		$("#upload_img_list #img_content").append(html)
		$(".delete_img").on("click",function(){
			$(this).fadeOut(500,function(){
				$(this).parent().remove();
			})
		})
	}
    reader.readAsDataURL(file); // 读出 base64
}
$(function(){
	$("#upload_img").css("display", "none")
	$("#upload_img_list").css("display", "inline-block")
	$("#upload_img_action").on('click',function(){
		$.ajax({  
			url:'/article_thumbnail_upload_action',  
			type:'post',  
			dataType:'json',
			data:img_upload_formdata,
			cache:false,
			processData:false,
			contentType:false,
			success:function(res) {
				
				$.each($("#upload_img_list #img_content img"), function(k,v){
					if (res.result.urls[k].url.indexOf($(this).attr("id")) != -1) {
						$(this).attr("src", res.result.urls[k].url)
					}
				})
				alert("上传成功")
			},  
			error:function() {  
				alert("异常！");  
			}  
		});
	})
	// 请求分类
	$.ajax({  
			url:'/category_article_action',  
			type:'get',  
			dataType:'json',  
			success:function(res) {
				$.each(res.data,function(k,v){
					var def_select = parseInt($("#article_category select").attr("defselect"))
					var eq_select = (def_select == v.type)
					var option = '<option ' +(eq_select ? 'selected="selected"' : '')+ ' value="'+v.type+'">'+v.title+'</option>'
					$("#article_category select").append(option)
				})
			},  
			error:function() {  
				alert("异常！");  
			}  
		});

	$('#submit_btn').on('click', function(){
		var imgs = []
		$.each($("#upload_img_list #img_content img"), function(k,v){
			if($(this).attr("src").indexOf("thumbnail") == -1) {
				alert("请先上传图片")
				return false
			}
			imgs[k] = $(this).attr("src")
		})
		// var data = $('#add_article_form').serialize()
		var datas = $('#add_article_form').serializeArray()
		var isNull = false
		$.each(datas, function(k,v){
			if(!v.value) {
				alert(v.name + "不能为空")
				isNull = true
			}
		})
		if (imgs.length > 0) {
			datas.push({"name" : "thumbnails", "value" : imgs})
		} else {
			datas.push({"name" : "thumbnails", "value" : []})
		}
	
		console.log(datas)
		if (isNull) return
		$.ajax( {  
			url:'/edit_article_action',
			data:JSON.stringify(datas),  
			type:'post',  
			dataType:'json',  
			success:function(data) {
				if (data.result == 'success') {
					alert('修改成功')
				} else {
					alert('修改失败')
				}
			},  
			error:function() {  
				alert("异常！");  
			}  
		});
	})
})
</script>